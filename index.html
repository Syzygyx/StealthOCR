<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StealthOCR - PDF Text Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #e8f0fe;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .processing-section {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .processing-section.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results-layout {
            display: none;
            margin-top: 30px;
        }

        .results-layout.show {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 80vh;
        }

        .pdf-viewer-section,
        .excel-section {
            display: flex;
            flex-direction: column;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            margin: 0;
            color: #333;
        }

        .pdf-controls,
        .excel-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .control-btn:hover:not(:disabled) {
            background: #5a6fd8;
        }

        .pdf-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .excel-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: white;
        }

        #pdfCanvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .page-info {
            font-size: 14px;
            color: #666;
            margin: 0 10px;
        }

        @media (max-width: 1200px) {
            .results-layout.show {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .pdf-viewer-section,
            .excel-section {
                min-height: 400px;
            }
        }

        .results-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .results-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            max-height: 500px;
            overflow-y: auto;
        }

        .text-output {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .download-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç StealthOCR</h1>
            <p>Extract text from PDF documents with advanced OCR technology</p>
        </div>

        <div class="main-content">
            <div class="upload-section" id="uploadSection" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" class="file-input" accept=".pdf" />
                <div class="upload-icon">üìÑ</div>
                <h3>Upload PDF Document</h3>
                <p>Drag and drop your PDF file here or click to browse</p>
                <button class="upload-btn" type="button">
                    Choose PDF File
                </button>
                <div class="file-info" id="fileInfo">
                    <strong>Selected file:</strong> <span id="fileName"></span><br>
                    <strong>Size:</strong> <span id="fileSize"></span>
                </div>
            </div>

            <div class="processing-section" id="processingSection">
                <div class="spinner"></div>
                <h3>Processing PDF...</h3>
                <p>Extracting text using OCR technology. This may take a few moments.</p>
            </div>

            <!-- Side-by-side layout -->
            <div class="results-layout" id="resultsLayout">
                <!-- PDF Viewer Section -->
                <div class="pdf-viewer-section">
                    <div class="section-header">
                        <h3>üìÑ PDF Document</h3>
                        <div class="pdf-controls">
                            <button class="control-btn" id="prevPage" disabled>‚Üê Previous</button>
                            <span id="pageInfo">Page 1 of 1</span>
                            <button class="control-btn" id="nextPage" disabled>Next ‚Üí</button>
                        </div>
                    </div>
                    <div class="pdf-container">
                        <canvas id="pdfCanvas"></canvas>
                    </div>
                </div>

                <!-- Excel Display Section -->
                <div class="excel-section">
                    <div class="section-header">
                        <h3>üìä Excel Output</h3>
                        <div class="excel-controls">
                            <button class="download-btn" id="downloadExcelBtn">Download Excel</button>
                            <button class="download-btn" id="downloadTxtBtn">Download TXT</button>
                        </div>
                    </div>
                    <div class="excel-container" id="excelContainer">
                        <!-- Excel preview will be displayed here -->
                    </div>
                </div>
            </div>

            <div id="messageContainer"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="js/excel-display.js"></script>
    <script>
        let extractedText = '';
        let fileName = '';
        let pdfFile = null;
        let pdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let excelDisplay = null;

        // File input handling
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const fileInfo = document.getElementById('fileInfo');
        const processingSection = document.getElementById('processingSection');
        const resultsLayout = document.getElementById('resultsLayout');
        const messageContainer = document.getElementById('messageContainer');
        
        // PDF viewer elements
        const pdfCanvas = document.getElementById('pdfCanvas');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        
        // Excel elements
        const excelContainer = document.getElementById('excelContainer');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn');
        const downloadTxtBtn = document.getElementById('downloadTxtBtn');

        // Drag and drop functionality
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Prevent button click from triggering file input twice
        document.querySelector('.upload-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('fileInput').click();
        });

        function handleFile(file) {
            if (!CONFIG.SUPPORTED_TYPES.includes(file.type)) {
                showMessage('Please select a PDF file.', 'error');
                return;
            }

            // Check file size
            const fileSizeMB = file.size / (1024 * 1024);
            if (fileSizeMB > CONFIG.MAX_FILE_SIZE) {
                showMessage(`File size too large. Maximum size is ${CONFIG.MAX_FILE_SIZE}MB.`, 'error');
                return;
            }

            fileName = file.name;
            pdfFile = file;
            showFileInfo(file);
            loadPDF(file);
            processPDF(file);
        }

        function showFileInfo(file) {
            const fileNameElement = document.getElementById('fileName');
            const fileSizeElement = document.getElementById('fileSize');
            
            fileNameElement.textContent = file.name;
            fileSizeElement.textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processPDF(file) {
            showProcessing();
            
            try {
                // Get API URL based on environment
                const API_URL = getApiUrl();
                
                if (!API_URL) {
                    // No API available - show demo mode
                    showDemoMode(file);
                    return;
                }
                
                // Convert file to base64
                const base64Data = await fileToBase64(file);
                
                // Prepare request body for Lambda API
                const requestBody = {
                    pdf_data: base64Data
                };
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    extractedText = result.text;
                    showResults(result);
                } else {
                    throw new Error(result.error || 'Failed to extract text');
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
                showMessage(`Error processing PDF: ${error.message}`, 'error');
                hideProcessing();
            }
        }
        
        function showDemoMode(file) {
            // Show demo mode with sample text
            const demoText = `=== DEMO MODE ===
This is a demonstration of StealthOCR's text extraction capabilities.

File: ${file.name}
Size: ${formatFileSize(file.size)}

In the full version, this would extract text from your PDF using:
- Tesseract OCR engine
- EasyOCR deep learning models
- Advanced image preprocessing
- Multi-language support

To use the full OCR functionality, you need to:
1. Deploy the AWS Lambda backend
2. Update the API URL in config.js
3. Or run the local development server

=== SAMPLE EXTRACTED TEXT ===
Based on your test PDF, here's what would be extracted:

REPROGRAMMING ACTION - INTERNAL REPROGRAMMING

Subject: Israel Security Replacement Transfer Fund Tranche 3
DoD Serial Number: [Extracted]

Appropriation Title: Various Appropriations FY 25-08 IR

This reprogramming action provides funding for the replacement of defense articles from the stocks of the Department of Defense expended in support of Israel and for the reimbursement of defense services of the Department of Defense provided to Israel.

The action is determined to be necessary in the national interest and meets all administrative and legal requirements.

[Additional text would be extracted from all pages...]`;

            const result = {
                success: true,
                text: demoText,
                engine: 'demo',
                pages_processed: 3,
                character_count: demoText.length,
                word_count: demoText.split(/\s+/).length
            };
            
            showResults(result);
            showMessage('Demo mode: No API backend configured. This shows sample extracted text.', 'success');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Remove data:application/pdf;base64, prefix
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        function showProcessing() {
            uploadSection.style.display = 'none';
            processingSection.classList.add('show');
            resultsLayout.classList.remove('show');
            clearMessages();
        }

        function hideProcessing() {
            processingSection.classList.remove('show');
        }

        function showResults(result) {
            hideProcessing();
            resultsLayout.classList.add('show');
            
            // Store extracted text
            extractedText = result.text;
            
            // Generate and display Excel
            generateExcelDisplay(result);
            
            showMessage('Text extracted successfully!', 'success');
        }

        async function loadPDF(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                totalPages = pdfDoc.numPages;
                currentPage = 1;
                
                updatePageControls();
                renderPage(currentPage);
            } catch (error) {
                console.error('Error loading PDF:', error);
                showMessage('Error loading PDF for viewing', 'error');
            }
        }

        async function renderPage(pageNum) {
            if (!pdfDoc) return;
            
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = pdfCanvas;
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                updatePageInfo();
            } catch (error) {
                console.error('Error rendering PDF page:', error);
            }
        }

        function updatePageControls() {
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
        }

        function updatePageInfo() {
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
        }

        async function generateExcelDisplay(result) {
            if (!excelDisplay) {
                excelDisplay = new ExcelDisplay();
            }
            
            try {
                const workbook = await excelDisplay.generateExcelFromOCR(result);
                excelDisplay.displayExcelPreview(workbook, 'excelContainer');
                
                // Set up download buttons
                downloadExcelBtn.onclick = () => {
                    const filename = fileName.replace('.pdf', '_extracted.xlsx');
                    excelDisplay.downloadExcel(workbook, filename);
                };
                
                downloadTxtBtn.onclick = () => {
                    const blob = new Blob([extractedText], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName.replace('.pdf', '_extracted.txt');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                };
                
            } catch (error) {
                console.error('Error generating Excel display:', error);
                excelContainer.innerHTML = '<p>Error generating Excel preview</p>';
            }
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message`;
            messageDiv.textContent = message;
            messageContainer.appendChild(messageDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        function clearMessages() {
            messageContainer.innerHTML = '';
        }

        // Configure PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Reset functionality
        function resetForm() {
            fileInput.value = '';
            fileName = '';
            extractedText = '';
            pdfFile = null;
            pdfDoc = null;
            currentPage = 1;
            totalPages = 0;
            
            uploadSection.style.display = 'block';
            fileInfo.classList.remove('show');
            processingSection.classList.remove('show');
            resultsLayout.classList.remove('show');
            
            // Clear PDF canvas
            const canvas = pdfCanvas;
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            // Clear Excel container
            excelContainer.innerHTML = '';
            
            clearMessages();
        }

        // PDF navigation
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updatePageControls();
                renderPage(currentPage);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                updatePageControls();
                renderPage(currentPage);
            }
        });

        // Add reset button functionality
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                resetForm();
            }
        });
    </script>
</body>
</html>